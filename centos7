printf "Installing required packages\n"
yum install -y php php-openssl php-mysql php-curl httpd mariadb mariadb-server git expect

printf "Enabling MySQL\n"
systemctl enable mariadb.service
systemctl start mariadb.service
printf "Enabling apache2\n"
systemctl enable httpd.service
systemctl start httpd.service

printf "Installing composer\n"
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer

printf "Downloading paypal sample app\n"
cd /var/www/html/ # assuming this is where we're storing stuff
git clone https://github.com/paypal/rest-api-sample-app-php.git

printf "Running composer update\n"
cd rest-api-sample-app-php
composer update

printf "Generating MySQL passwords\n"
mysql_root_password=$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c16)
export mysql_root_password # because expect is silly
mysql_paypaluser_password=$(< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c16)

printf "Setting up MySQL\n"
/usr/bin/expect -c '
set timeout 2

log_user 0 # hide output, add option for -v?
spawn mysql_secure_installation
expect "Enter current password for root (enter for none): "
send "\r"
expect "Change the root password? \[Y/n\] "
send "Y\r"
expect "New password: "
send "$env(mysql_root_password)\r"
expect "Re-enter new password: "
send "$env(mysql_root_password)\r"
expect "Remove anonymous users? \[Y/n\] "
send "Y\r"
expect "Disallow root login remotely? \[Y/n\] "
send "Y\r"
expect "Remove test database and access to it? \[Y/n\] "
send "Y\r"
expect "Reload privilege tables now? \[Y/n\] "
send "Y\r" '

mysql -uroot -p"$mysql_root_password" -e "create database paypal_pizza_app;"
mysql -uroot -p"$mysql_root_password" -e "grant all privileges on paypal_pizza_app.* to paypal_user@localhost identified by '$mysql_paypaluser_password';"
mysql -uroot -p"$mysql_root_password" paypal_pizza_app < install/db.sql

printf "Setting MySQL login details within app config\n"
sed -i "s/'MYSQL_USERNAME', 'root'/'MYSQL_USERNAME', 'paypal_user'/; s/'MYSQL_PASSWORD', 'root'/'MYSQL_PASSWORD', '$mysql_paypaluser_password'/" /var/www/html/rest-api-sample-app-php/app/bootstrap.php

printf "Setting firewall rules\n"
printf "allow http traffic: "
firewall-cmd --zone=public --add-service=http --permanent
printf "allow https traffic: "
firewall-cmd --zone=public --add-service=https --permanent
printf "Reloading firewall: "
firewall-cmd --reload

printf "mysql root password is: $mysql_root_password\n"
printf "mysql application user password is: $mysql_paypaluser_password\n"
